<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>CRUD Livros [v06]</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f4f6f9;
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .spinner-border {
      width: 1.5rem;
      height: 1.5rem;
    }
    .btn {
      border-radius: 999px;
    }
  </style>
</head>
<body class="container py-5">

  <div class="row mb-4">
    <div class="col-md-8 mx-auto">
      <div class="card p-4">
        <h4 class="mb-4">üìö Cadastro de Livros</h4>

        <div id="alertPlaceholder"></div>

        <form id="livroForm">
          <input type="hidden" id="livroId">
          <div class="mb-3">
            <input type="text" id="titulo" class="form-control form-control-lg" placeholder="T√≠tulo" required />
          </div>
          <div class="mb-3">
            <input type="text" id="autor" class="form-control form-control-lg" placeholder="Autor" required />
          </div>
          <div class="mb-3">
            <input type="number" id="ano" class="form-control form-control-lg" placeholder="Ano" required />
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <button type="submit" class="btn btn-primary px-4" id="salvarBtn">Salvar</button>
            <div id="loadingIndicator" class="spinner-border text-primary d-none" role="status"></div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-10 mx-auto">
      <div class="card p-4">
        <h5 class="mb-3">üìñ Lista de Livros</h5>
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>T√≠tulo</th>
              <th>Autor</th>
              <th>Ano</th>
              <th class="text-end">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="livrosTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbx7Pz-J6xNu8i4BA_SIIyVT_Oyd0Sc5ffN0wHfTxR8BkuAikXh0t-qCL-TIZdWz_gCn/exec';

    const livroForm = document.getElementById("livroForm");
    const salvarBtn = document.getElementById("salvarBtn");
    const loading = document.getElementById("loadingIndicator");
    const livrosTable = document.getElementById("livrosTable");
    const alertPlaceholder = document.getElementById("alertPlaceholder");

    function showAlert(message, type = "success") {
      alertPlaceholder.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
    }

    function toggleLoading(isLoading) {
      salvarBtn.disabled = isLoading;
      loading.classList.toggle("d-none", !isLoading);
    }

    async function carregarLivros() {
      toggleLoading(true);
      const res = await fetch(API_URL);
      const livros = await res.json();

      livros.sort((a, b) => a.titulo.localeCompare(b.titulo));

      livrosTable.innerHTML = "";
      livros.forEach(livro => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${livro.titulo}</td>
          <td>${livro.autor}</td>
          <td>${livro.ano}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-warning me-1" onclick='editar(${JSON.stringify(livro)})'>‚úèÔ∏è</button>
            <button class="btn btn-sm btn-outline-danger" onclick='deletar(${livro.id})'>üóëÔ∏è</button>
          </td>
        `;
        livrosTable.appendChild(tr);
      });
      toggleLoading(false);
    }

    livroForm.addEventListener("submit", async e => {
      e.preventDefault();
      toggleLoading(true);

      const id = document.getElementById("livroId").value;
      const data = {
        titulo: document.getElementById("titulo").value.trim(),
        autor: document.getElementById("autor").value.trim(),
        ano: document.getElementById("ano").value.trim(),
        id: id || undefined
      };

      try {
        await fetch(API_URL, {
          method: id ? "PUT" : "POST",
          body: JSON.stringify(data)
        });

        livroForm.reset();
        document.getElementById("livroId").value = "";
        showAlert(`Livro ${id ? "atualizado" : "cadastrado"} com sucesso!`);
        carregarLivros();
      } catch (err) {
        showAlert("Erro ao salvar livro!", "danger");
      }

      toggleLoading(false);
    });

    function editar(livro) {
      document.getElementById("livroId").value = livro.id;
      document.getElementById("titulo").value = livro.titulo;
      document.getElementById("autor").value = livro.autor;
      document.getElementById("ano").value = livro.ano;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deletar(id) {
      if (!confirm("Tem certeza que deseja excluir este livro?")) return;

      toggleLoading(true);
      try {
        await fetch(`${API_URL}?id=${id}`, { method: "DELETE" });
        showAlert("Livro removido com sucesso!");
        carregarLivros();
      } catch {
        showAlert("Erro ao deletar livro!", "danger");
      }
      toggleLoading(false);
    }

    carregarLivros();
  </script>
</body>
</html>
