<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRUD Livros [v14]</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f4f6f9;
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .spinner-border {
      width: 1.5rem;
      height: 1.5rem;
    }
    .btn {
      border-radius: 999px;
    }
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1055;
    }
  </style>
</head>
<body class="container py-5">

  <!-- Toast container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Modal -->
  <div class="modal fade" id="livroModal" tabindex="-1" aria-labelledby="livroModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="livroForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="livroModalLabel">üìö Cadastro de Livro</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="livroId">
          <div class="mb-3">
            <input type="text" id="titulo" class="form-control form-control-lg" placeholder="T√≠tulo" required />
          </div>
          <div class="mb-3">
            <input type="text" id="autor" class="form-control form-control-lg" placeholder="Autor" required />
          </div>
          <div class="mb-3">
            <input type="number" id="ano" class="form-control form-control-lg" placeholder="Ano" required />
          </div>
        </div>
        <div class="modal-footer">
          <div id="formLoading" class="spinner-border text-primary d-none" role="status"></div>
          <button type="submit" class="btn btn-primary" id="salvarBtn">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bot√£o adicionar livro -->
  <div class="d-flex justify-content-end mb-3">
    <button class="btn btn-success px-4" data-bs-toggle="modal" data-bs-target="#livroModal" onclick="abrirModal()">+ Novo Livro</button>
  </div>

  <!-- Lista de livros -->
  <div class="card p-4">
    <h5 class="mb-3">üìñ Lista de Livros</h5>
    <div id="tableLoading" class="d-flex justify-content-center my-3 d-none">
      <div class="spinner-border text-primary" role="status"></div>
    </div>
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>T√≠tulo</th>
          <th>Autor</th>
          <th>Ano</th>
          <th class="text-end">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="livrosTable"></tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbxXtAx3lpUHsh0TIUVybSOW95YaKZLhrjgWO4SIm-nNA29zUKD_FIKLeI9hHutoEl4/exec';

  const livroForm = document.getElementById("livroForm");
  const salvarBtn = document.getElementById("salvarBtn");
  const formLoading = document.getElementById("formLoading");
  const tableLoading = document.getElementById("tableLoading");
  const livrosTable = document.getElementById("livrosTable");
  const toastContainer = document.getElementById("toastContainer");
  const modalElement = new bootstrap.Modal(document.getElementById('livroModal'));

  function showToast(message, type = "success") {
    const toast = document.createElement("div");
    toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
    toast.role = "alert";
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          ${type === 'success' ? '‚úÖ' : '‚ùå'} ${message}
        </div>
        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
      </div>
    `;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
  }

  function toggleFormLoading(isLoading) {
    salvarBtn.disabled = isLoading;
    formLoading.classList.toggle("d-none", !isLoading);
  }

  function toggleTableLoading(isLoading) {
    tableLoading.classList.toggle("d-none", !isLoading);
  }

  function abrirModal() {
    livroForm.reset();
    document.getElementById("livroId").value = "";
    modalElement.show();
  }

  function carregarLivros() {
    toggleTableLoading(true);

    const xhr = new XMLHttpRequest();
    xhr.open('GET', API_URL, true);

    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        toggleTableLoading(false);

        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const response = JSON.parse(xhr.responseText);
            const { success, data } = response;

            if (!success || !Array.isArray(data)) throw new Error("Formato inv√°lido");

            data.sort((a, b) => a.titulo.localeCompare(b.titulo));
            livrosTable.innerHTML = "";

            data.forEach(livro => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${livro.titulo}</td>
                <td>${livro.autor}</td>
                <td>${livro.ano}</td>
                <td class="text-end">
                  <button class="btn btn-sm btn-outline-warning me-1" onclick='editar(${JSON.stringify(livro)})'>‚úèÔ∏è</button>
                  <button class="btn btn-sm btn-outline-danger" onclick='confirmarExclusao("${livro.id}")'>üóëÔ∏è</button>
                </td>
              `;
              livrosTable.appendChild(tr);
            });
          } catch (e) {
            showToast("Erro ao processar resposta dos livros!", "danger");
            console.error("Erro no parse do JSON:", e);
          }
        } else {
          showToast("Erro ao carregar livros!", "danger");
          console.error("Erro na requisi√ß√£o:", xhr.status, xhr.statusText);
        }
      }
    };

    xhr.onerror = function () {
      showToast("Erro ao carregar livros!", "danger");
      toggleTableLoading(false);
    };

    xhr.send();
  }

  livroForm.addEventListener("submit", async e => {
    e.preventDefault();
    toggleFormLoading(true);

    const id = document.getElementById("livroId").value;
    const data = {
      titulo: document.getElementById("titulo").value.trim(),
      autor: document.getElementById("autor").value.trim(),
      ano: document.getElementById("ano").value.trim(),
    };

    const payload = id ? { action: "update", id, ...data } : { action: "create", ...data };

    salvarLivro(payload);
    toggleFormLoading(false);
  });

  function salvarLivro(payload) {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', API_URL, true);
    xhr.setRequestHeader('Content-Type', 'application/json');

    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const json = JSON.parse(xhr.responseText);
            if (json.success) {
              showToast(json.message || "Livro salvo com sucesso!");
              modalElement.hide();
              carregarLivros();
            } else {
              showToast(json.message || "Erro ao salvar livro!", "danger");
            }
          } catch (e) {
            showToast("Erro ao salvar livro!", "danger");
            console.error("Erro no parse do JSON:", e);
          }
        } else {
          showToast("Erro ao salvar livro!", "danger");
          console.error("Erro na requisi√ß√£o:", xhr.status, xhr.statusText);
        }
      }
    };

    xhr.onerror = function () {
      showToast("Erro ao salvar livro!", "danger");
    };

    xhr.send(JSON.stringify(payload));
  }

  function editar(livro) {
    document.getElementById("livroId").value = livro.id;
    document.getElementById("titulo").value = livro.titulo;
    document.getElementById("autor").value = livro.autor;
    document.getElementById("ano").value = livro.ano;
    modalElement.show();
  }

  function confirmarExclusao(id) {
    mostrarConfirmacao("Tem certeza que deseja excluir este livro?").then(confirmed => {
      if (!confirmed) return;

      const payload = { action: "delete", id };
      const xhr = new XMLHttpRequest();
      xhr.open('POST', API_URL, true);
      xhr.setRequestHeader('Content-Type', 'application/json');

      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const json = JSON.parse(xhr.responseText);
              if (json.success) {
                showToast(json.message || "Livro exclu√≠do com sucesso!");
                carregarLivros();
              } else {
                showToast(json.message || "Erro ao excluir livro!", "danger");
              }
            } catch (e) {
              showToast("Erro ao excluir livro!", "danger");
              console.error("Erro no parse do JSON:", e);
            }
          } else {
            showToast("Erro ao excluir livro!", "danger");
            console.error("Erro na requisi√ß√£o:", xhr.status, xhr.statusText);
          }
        }
      };

      xhr.onerror = function () {
        showToast("Erro ao excluir livro!", "danger");
      };

      xhr.send(JSON.stringify(payload));
    });
  }

  function mostrarConfirmacao(msg) {
    return new Promise(resolve => {
      const modalHtml = `
        <div class="modal fade" id="confirmModal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Confirmar A√ß√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <p>${msg}</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmBtn">Confirmar</button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML("beforeend", modalHtml);
      const confirmModalEl = document.getElementById("confirmModal");
      const bsModal = new bootstrap.Modal(confirmModalEl);
      bsModal.show();

      confirmModalEl.querySelector("#confirmBtn").onclick = () => {
        resolve(true);
        bsModal.hide();
      };

      confirmModalEl.addEventListener("hidden.bs.modal", () => {
        resolve(false);
        confirmModalEl.remove();
      });
    });
  }

  carregarLivros();
</script>

</body>
</html>
