<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>CRUD Livros [v12]</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f4f6f9;
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .spinner-border {
      width: 1.5rem;
      height: 1.5rem;
    }
    .btn {
      border-radius: 999px;
    }
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1055;
    }
  </style>
</head>
<body class="container py-5">

  <!-- Toast container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Modal -->
  <div class="modal fade" id="livroModal" tabindex="-1" aria-labelledby="livroModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="livroForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="livroModalLabel">üìö Cadastro de Livro</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="livroId">
          <div class="mb-3">
            <input type="text" id="titulo" class="form-control form-control-lg" placeholder="T√≠tulo" required />
          </div>
          <div class="mb-3">
            <input type="text" id="autor" class="form-control form-control-lg" placeholder="Autor" required />
          </div>
          <div class="mb-3">
            <input type="number" id="ano" class="form-control form-control-lg" placeholder="Ano" required />
          </div>
        </div>
        <div class="modal-footer">
          <div id="formLoading" class="spinner-border text-primary d-none" role="status"></div>
          <button type="submit" class="btn btn-primary" id="salvarBtn">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bot√£o adicionar livro -->
  <div class="d-flex justify-content-end mb-3">
    <button class="btn btn-success px-4" data-bs-toggle="modal" data-bs-target="#livroModal" onclick="abrirModal()">+ Novo Livro</button>
  </div>

  <!-- Lista de livros -->
  <div class="card p-4">
    <h5 class="mb-3">üìñ Lista de Livros</h5>
    <div id="tableLoading" class="d-flex justify-content-center my-3 d-none">
      <div class="spinner-border text-primary" role="status"></div>
    </div>
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>T√≠tulo</th>
          <th>Autor</th>
          <th>Ano</th>
          <th class="text-end">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="livrosTable"></tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbxN4dnpGaQAnvLw6nO0tptzu1-7zc-2HK8-X-ET43hlu7ou6P6Y3nDfDdAwBZPjDKbN/exec';

  const livroForm = document.getElementById("livroForm");
  const salvarBtn = document.getElementById("salvarBtn");
  const formLoading = document.getElementById("formLoading");
  const tableLoading = document.getElementById("tableLoading");
  const livrosTable = document.getElementById("livrosTable");
  const toastContainer = document.getElementById("toastContainer");
  const modalElement = new bootstrap.Modal(document.getElementById('livroModal'));

  function showToast(message, type = "success") {
    const toast = document.createElement("div");
    toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
    toast.role = "alert";
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          ${type === 'success' ? '‚úÖ' : '‚ùå'} ${message}
        </div>
        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
      </div>
    `;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
  }

  function toggleFormLoading(isLoading) {
    salvarBtn.disabled = isLoading;
    formLoading.classList.toggle("d-none", !isLoading);
  }

  function toggleTableLoading(isLoading) {
    tableLoading.classList.toggle("d-none", !isLoading);
  }

  function abrirModal() {
    livroForm.reset();
    document.getElementById("livroId").value = "";
    modalElement.show();
  }

  async function carregarLivros() {
    toggleTableLoading(true);
    try {
      const data = new URLSearchParams();
      data.append("action", "get");
      
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { "Content-Type": "text/plain" },
        body: data.toString()
      });
      const { success, data } = await res.json();
      if (!success) throw new Error();

      data.sort((a, b) => a.titulo.localeCompare(b.titulo));
      livrosTable.innerHTML = "";

      data.forEach(livro => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${livro.titulo}</td>
          <td>${livro.autor}</td>
          <td>${livro.ano}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-warning me-1" onclick='editar(${JSON.stringify(livro)})'>‚úèÔ∏è</button>
            <button class="btn btn-sm btn-outline-danger" onclick='confirmarExclusao("${livro.id}")'>üóëÔ∏è</button>
          </td>
        `;
        livrosTable.appendChild(tr);
      });
    } catch (err) {
      showToast("Erro ao carregar livros!", "danger");
    }
    toggleTableLoading(false);
  }

  livroForm.addEventListener("submit", async e => {
    e.preventDefault();
    toggleFormLoading(true);

    const id = document.getElementById("livroId").value;
    const data = {
      titulo: document.getElementById("titulo").value.trim(),
      autor: document.getElementById("autor").value.trim(),
      ano: document.getElementById("ano").value.trim(),
    };

    const payload = id ? { action: "update", id, ...data } : { action: "create", ...data };

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const json = await res.json();

      if (json.success) {
        showToast(json.message || "Livro salvo com sucesso!");
        modalElement.hide();
        carregarLivros();
      } else {
        showToast(json.message || "Erro ao salvar livro!", "danger");
      }
    } catch (err) {
      showToast("Erro ao salvar livro!", "danger");
    }

    toggleFormLoading(false);
  });

  function editar(livro) {
    document.getElementById("livroId").value = livro.id;
    document.getElementById("titulo").value = livro.titulo;
    document.getElementById("autor").value = livro.autor;
    document.getElementById("ano").value = livro.ano;
    modalElement.show();
  }

  async function confirmarExclusao(id) {
    const confirmed = await mostrarConfirmacao("Tem certeza que deseja excluir este livro?");
    if (confirmed) {
      try {
        const payload = { action: "delete", id };
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const json = await res.json();

        if (json.success) {
          showToast(json.message || "Livro exclu√≠do com sucesso!");
          carregarLivros();
        } else {
          showToast(json.message || "Erro ao excluir livro!", "danger");
        }
      } catch {
        showToast("Erro ao deletar livro!", "danger");
      }
    }
  }

  function mostrarConfirmacao(msg) {
    return new Promise(resolve => {
      const modalHtml = `
        <div class="modal fade" id="confirmModal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Confirmar A√ß√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <p>${msg}</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmBtn">Confirmar</button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML("beforeend", modalHtml);
      const confirmModalEl = document.getElementById("confirmModal");
      const bsModal = new bootstrap.Modal(confirmModalEl);
      bsModal.show();

      confirmModalEl.querySelector("#confirmBtn").onclick = () => {
        resolve(true);
        bsModal.hide();
      };

      confirmModalEl.addEventListener("hidden.bs.modal", () => {
        resolve(false);
        confirmModalEl.remove();
      });
    });
  }

  carregarLivros();
</script>
</body>
</html>
